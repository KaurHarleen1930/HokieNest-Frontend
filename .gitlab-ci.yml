# ============================================
# HokieNest GitLab CI/CD Pipeline
# ============================================

stages:
  - build
  - test
  - deploy-staging
  - deploy-production

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  FRONTEND_IMAGE: kaurharleenvt/hokienest-frontend
  BACKEND_IMAGE: kaurharleenvt/hokienest-backend

# ============================================
# BUILD JOBS (Automatic on every commit)
# ============================================

build-frontend:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
  script:
    - echo "ðŸ”¨ Building Frontend..."
    - |
      docker build \
        --build-arg VITE_SUPABASE_URL="$VITE_SUPABASE_URL" \
        --build-arg VITE_SUPABASE_ANON_KEY="$VITE_SUPABASE_ANON_KEY" \
        --build-arg VITE_API_URL="$VITE_API_URL" \
        -t $FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA \
        -t $FRONTEND_IMAGE:latest \
        .
    - docker push $FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $FRONTEND_IMAGE:latest
    - echo "âœ… Frontend built and pushed!"
  only:
    - main
  tags:
    - hokienest

build-backend:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
  script:
    - echo "ðŸ”¨ Building Backend..."
    - |
      docker build \
        -t $BACKEND_IMAGE:$CI_COMMIT_SHORT_SHA \
        -t $BACKEND_IMAGE:latest \
        ./server
    - docker push $BACKEND_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $BACKEND_IMAGE:latest
    - echo "âœ… Backend built and pushed!"
  only:
    - main
  tags:
    - hokienest

# ============================================
# TEST JOBS (Automatic after build)
# ============================================

test-frontend:
  stage: test
  image: node:18-alpine
  script:
    - echo "ðŸ§ª Running frontend tests..."
    - npm ci
    - npm run lint || echo "âš ï¸ Linting issues found"
    - echo "âœ… Tests passed!"
  only:
    - main
  tags:
    - hokienest

test-backend:
  stage: test
  image: node:18-alpine
  script:
    - echo "ðŸ§ª Running backend tests..."
    - cd server
    - npm ci
    - echo "âœ… Tests passed!"
  only:
    - main
  tags:
    - hokienest

# ============================================
# STAGING DEPLOYMENT (Automatic on main)
# ============================================

deploy-staging:
  stage: deploy-staging
  image: bitnami/kubectl:latest
  before_script:
    - echo "$KUBECONFIG_CONTENT" | base64 -d > /tmp/kubeconfig
    - export KUBECONFIG=/tmp/kubeconfig
  script:
    - echo "ðŸš€ Deploying to Staging..."
    - kubectl delete pod -l app=hokienest-frontend -n $KUBE_NAMESPACE || true
    - kubectl delete pod -l app=hokienest-backend -n $KUBE_NAMESPACE || true
    - sleep 15
    - kubectl get pods -n $KUBE_NAMESPACE
    - echo "âœ… Staging deployed!"
  environment:
    name: staging
    url: https://hokienest.discovery.cs.vt.edu
  only:
    - main
  tags:
    - hokienest

# ============================================
# PRODUCTION DEPLOYMENT (Manual trigger)
# ============================================

deploy-production:
  stage: deploy-production
  image: bitnami/kubectl:latest
  before_script:
    - echo "$KUBECONFIG_CONTENT" | base64 -d > /tmp/kubeconfig
    - export KUBECONFIG=/tmp/kubeconfig
  script:
    - echo "ðŸš€ Deploying to Production..."
    - kubectl delete pod -l app=hokienest-frontend -n $KUBE_NAMESPACE || true
    - kubectl delete pod -l app=hokienest-backend -n $KUBE_NAMESPACE || true
    - sleep 15
    - kubectl get pods -n $KUBE_NAMESPACE
    - echo "âœ… Production deployed!"
    - echo "ðŸŽ‰ Live at: https://hokienest.discovery.cs.vt.edu"
  environment:
    name: production
    url: https://hokienest.discovery.cs.vt.edu
  when: manual
  only:
    - main
  tags:
    - hokienest